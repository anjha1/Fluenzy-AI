generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

enum Role {
  User
  Admin
  Modaretor
  SUPER_ADMIN
}

enum Plan {
  Free
  Standard
  Pro
  Enterprise
}

enum DiscountType {
  PERCENTAGE
  FLAT
}

model users {
  id               String   @id @default(auto()) @map("_id") @db.ObjectId
  name             String
  email            String   @unique
  password         String?
  avatar           String?
  stripeCustomerId String?
  plan             Plan     @default(Free)
  role             Role     @default(User)
  usageCount       Int      @default(0)
  usageLimit       Int      @default(3)
  // Training module usage counters
  englishUsage     Int      @default(0)
  dailyUsage       Int      @default(0)
  hrUsage          Int      @default(0)
  technicalUsage   Int      @default(0)
  companyUsage     Int      @default(0)
  mockUsage        Int      @default(0)
  gdUsage          Int      @default(0)
  renewalDate      DateTime?
  disabled         Boolean  @default(false)
  sessions         Session[]
  lessonProgress   LessonProgress[]
  hrProgress       HRProgress[]
  resumes          Resume[]
  loginLogs        UserLoginLog[]
  couponUsages     CouponUsage[]
  paymentHistories PaymentHistory[]
  profile          UserProfile?
  subscriptions    subscriptions[]
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
}

model UserProfile {
  id                   String   @id @default(auto()) @map("_id") @db.ObjectId
  userId               String   @unique @db.ObjectId
  user                 users    @relation(fields: [userId], references: [id], onDelete: Cascade)
  username             String   @unique
  headline             String?
  bio                  String?
  socialLinks          Json?
  openToWork           Boolean  @default(false)
  publicProfileEnabled Boolean  @default(false)
  publicSections       Json?
  skills               Skill[]
  experiences          Experience[]
  educations           Education[]
  certifications       Certification[]
  projects             Project[]
  courses              Course[]
  languages            Language[]
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
}

model Skill {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  profileId   String   @db.ObjectId
  profile     UserProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)
  name        String
  level       String
  createdAt   DateTime @default(now())
}

model Experience {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  profileId   String   @db.ObjectId
  profile     UserProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)
  role        String
  company     String
  startDate   DateTime
  endDate     DateTime?
  description String?
  createdAt   DateTime @default(now())
}

model Education {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  profileId   String   @db.ObjectId
  profile     UserProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)
  degree      String
  institution String
  startYear   Int
  endYear     Int?
  grade       String?
  createdAt   DateTime @default(now())
}

model Certification {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  profileId   String   @db.ObjectId
  profile     UserProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)
  name        String
  issuer      String
  issueDate   DateTime
  credentialUrl String?
  skills      String[]
  createdAt   DateTime @default(now())
}

model Project {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  profileId   String   @db.ObjectId
  profile     UserProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)
  title       String
  description String?
  techStack   String?
  projectUrl  String?
  repoUrl     String?
  createdAt   DateTime @default(now())
}

model Course {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  profileId   String   @db.ObjectId
  profile     UserProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)
  name        String
  platform    String
  status      String
  createdAt   DateTime @default(now())
}

model Language {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  profileId   String   @db.ObjectId
  profile     UserProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)
  name        String
  proficiency String
  createdAt   DateTime @default(now())
}

model subscriptions {
  id                   String   @id @default(auto()) @map("_id") @db.ObjectId
  userId               String   @db.ObjectId
  user                 users    @relation(fields: [userId], references: [id], onDelete: Cascade)
  stripeSubscriptionId String
  stripeCustomerId     String
  plan                 Plan     @default(Pro)
  status               String   @default("active") // active, failed, cancelled, expired
  currentPeriodEnd     DateTime?
  autoRenew            Boolean  @default(true)
  paymentMethod        String?
  invoiceId            String?
  amount               Float?
  discountAmount       Float    @default(0)
  couponUsed           String?  // coupon code
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
}

model Session {
  id             String   @id @default(auto()) @map("_id") @db.ObjectId
  sessionId      String   @unique
  userId         String   @db.ObjectId
  user           users    @relation(fields: [userId], references: [id], onDelete: Cascade)
  module         String
  targetCompany  String?
  role           String?
  startTime      DateTime @default(now())
  endTime        DateTime?
  duration       Int? // in minutes
  aggregateScore Float?
  status         String? // PASS or FAIL
  resumeId       String? @db.ObjectId
  resume         Resume? @relation(fields: [resumeId], references: [id])
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  transcripts    Transcript[]
}

model Transcript {
  id                      String   @id @default(auto()) @map("_id") @db.ObjectId
  sessionId               String   @db.ObjectId
  session                 Session  @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  turnNumber              Int
  aiPrompt                String
  userAnswer              String // raw speech-to-text
  aiFeedback              String
  idealAnswer             String
  clarityScore            Float?
  relevanceScore          Float?
  grammarScore            Float?
  confidenceScore         Float?
  technicalAccuracyScore  Float?
  perQuestionScore        Float?
  createdAt               DateTime @default(now())
}

model LessonProgress {
  id           String   @id @default(auto()) @map("_id") @db.ObjectId
  userId       String   @db.ObjectId
  user         users    @relation(fields: [userId], references: [id], onDelete: Cascade)
  lessonId     String
  isCompleted  Boolean  @default(false)
  completedAt  DateTime?
  score        Float?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@unique([userId, lessonId])
}

model HRProgress {
  id           String   @id @default(auto()) @map("_id") @db.ObjectId
  userId       String   @db.ObjectId
  user         users    @relation(fields: [userId], references: [id], onDelete: Cascade)
  lessonId     String
  isCompleted  Boolean  @default(false)
  completedAt  DateTime?
  score        Float?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@unique([userId, lessonId])
}

model Resume {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  userId      String   @db.ObjectId
  user        users    @relation(fields: [userId], references: [id], onDelete: Cascade)
  fileName    String
  fileUrl     String
  uploadedAt  DateTime @default(now())
  sessions    Session[]
}

model UserLoginLog {
  id              String   @id @default(auto()) @map("_id") @db.ObjectId
  userId          String   @db.ObjectId
  user            users    @relation(fields: [userId], references: [id], onDelete: Cascade)
  loginTime       DateTime
  logoutTime      DateTime?
  sessionDuration Int? // in seconds
  ip              String?
  location        String? // country/city
  deviceType      String? // Mobile, Laptop, Tablet, Desktop
  os              String? // Android, iOS, Windows, macOS, Linux
  browser         String? // Chrome, Safari, etc.
  status          String   @default("success") // success, failed
  createdAt       DateTime @default(now())
}

model Coupon {
  id              String       @id @default(auto()) @map("_id") @db.ObjectId
  code            String       @unique
  discountType    DiscountType
  discountValue   Float
  maxUsage        Int?
  perUserLimit    Int          @default(1)
  usedCount       Int          @default(0)
  startDate       DateTime?
  expiryDate      DateTime?
  applicablePlans String[]     // e.g. ["Pro", "Enterprise"]
  status          String       @default("active") // active, inactive, expired
  createdBy       String       @db.ObjectId // superadmin user id
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  usages          CouponUsage[]
}

model CouponUsage {
  id             String   @id @default(auto()) @map("_id") @db.ObjectId
  couponId       String   @db.ObjectId
  userId         String   @db.ObjectId
  appliedPlan    String?
  originalPrice  Float?
  discountAmount Float    @default(0)
  finalPrice     Float?
  couponCode     String?
  appliedAt      DateTime? @default(now())
  coupon         Coupon   @relation(fields: [couponId], references: [id], onDelete: Cascade)
  user           users    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([couponId, userId])
}

model PaymentHistory {
  id            String   @id @default(auto()) @map("_id") @db.ObjectId
  userId        String   @db.ObjectId
  user          users    @relation(fields: [userId], references: [id], onDelete: Cascade)
  paymentId     String?
  orderId       String?
  plan          String?
  billingCycle  String?
  paymentCurrency String?
  originalAmount Float?
  discountAmount Float    @default(0)
  finalAmount   Float
  paymentMethod String?
  invoiceId     String?
  status        String   // paid, failed, refunded, free_via_coupon
  couponUsed    String?  // coupon code
  couponType    String?  // percentage, flat
  date          DateTime @default(now())
  receipt       Receipt?
}

model Receipt {
  id               String   @id @default(auto()) @map("_id") @db.ObjectId
  paymentHistoryId String   @db.ObjectId
  paymentHistory   PaymentHistory @relation(fields: [paymentHistoryId], references: [id], onDelete: Cascade)
  userId           String   @db.ObjectId
  orderId          String?
  paymentId        String?
  invoiceNumber    String
  currency         String   @default("INR")
  billingCycle     String?
  plan             String?
  originalAmount   Float?
  discountAmount   Float    @default(0)
  finalAmount      Float
  couponCode       String?
  couponType       String?
  discountValue    Float?
  issuedAt         DateTime @default(now())
  validFrom        DateTime?
  validTill        DateTime?
  receiptUrl       String?
  snapshot         Json?

  @@unique([paymentHistoryId])
}

model PlanPricing {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  plan        Plan     @unique
  name        String   // Display name
  price       Float    @default(0) // Monthly price
  currency    String   @default("INR")
  status      String   @default("active") // active, disabled
  updatedBy   String?  @db.ObjectId
  updatedAt   DateTime @updatedAt
  createdAt   DateTime @default(now())
}

model GlobalPlanSettings {
  id            String   @id @default(auto()) @map("_id") @db.ObjectId
  plan          Plan     @unique
  monthlyLimit  Int?
  isUnlimited   Boolean  @default(false)
  status        String   @default("active") // active, disabled
  lastReset     DateTime @default(now())
  updatedBy     String?  @db.ObjectId
  updatedAt     DateTime @updatedAt
  createdAt     DateTime @default(now())
}